#!/usr/bin/env ucode
'use strict';

// å¼•å…¥å¿…è¦çš„åº“
import { stdin, stdout, popen } from 'fs';
import dispatch from 'luci.dispatcher';
import request from 'luci.http';
import { load as i18n_load, translate as _ } from 'luci.i18n';

// åˆå§‹åŒ– i18n
i18n_load('simple2fa');

// åˆå§‹åŒ–å˜é‡
const input_bufsize = 4096;
let content_len = +getenv('CONTENT_LENGTH') || 0;
let buffer = null;
let buffer_pos = 0;
let response_buffer = "";
let is_login_page = false;

// ==========================================================
// ğŸ›¡ï¸ 2FA æ‹¦æˆªæ ¸å¿ƒé€»è¾‘ (å¼€å§‹)
// ==========================================================

// 1. åªæ‹¦æˆªå°ä½“ç§¯çš„ POST è¯·æ±‚ (é˜²æ­¢æ‹¦æˆªæ–‡ä»¶ä¸Šä¼ å¯¼è‡´å†…å­˜æº¢å‡º)
if (getenv('REQUEST_METHOD') == 'POST' && content_len > 0 && content_len < 10240) {
    // è¯»å–è¯·æ±‚ä½“åˆ°å†…å­˜
    buffer = stdin.read(content_len);
    
    // 2. ç®€å•çš„æ­£åˆ™åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦æ˜¯ root ç™»å½•
    let user_match = match(buffer, /luci_username=([^&]+)/);
    
    if (user_match && user_match[1] == 'root') {
        // 3. æ£€æŸ¥å¼€å…³çŠ¶æ€
        let p = popen('uci get simple2fa.global.enabled');
        let enabled = p.read('all');
        p.close();
        
        if (enabled && replace(enabled, "\n", "") == '1') {
            // 4. è·å–å¯†é’¥
            p = popen('uci get simple2fa.global.secret');
            let secret = p.read('all');
            p.close();
            
            if (secret) {
                secret = replace(secret, "\n", "");
                
                // 5. ä»è¯·æ±‚ä½“ä¸­æå– token
                let token_match = match(buffer, /token=([^&]*)/);
                let token = token_match ? token_match[1] : "";
                
                // 6. è°ƒç”¨ oathtool è®¡ç®—æ­£ç¡®éªŒè¯ç 
                p = popen(`oathtool -b --totp -d 6 '${secret}'`);
                let correct_code = p.read('all');
                p.close();
                
                if (correct_code) {
                    correct_code = replace(correct_code, "\n", "");
                    
                    // 7. æœ€ç»ˆæ¯”å¯¹
                    if (token != correct_code) {
                        print("Status: 302 Found\r\n");
                        print("Location: /cgi-bin/luci?simple2fa_err=1\r\n\r\n");
                        exit(0);
                    }
                }
            }
        }
    }
}

// æ£€æµ‹æ˜¯å¦æ˜¯ç™»å½•é¡µé¢è¯·æ±‚ (GET è¯·æ±‚ä¸”æ—  stok å‚æ•°)
let query_string = getenv('QUERY_STRING') ?? "";
let request_uri = getenv('REQUEST_URI') ?? "";
if (getenv('REQUEST_METHOD') == 'GET' && 
    (request_uri == '/cgi-bin/luci' || request_uri == '/cgi-bin/luci/' || 
     index(query_string, 'simple2fa_err') != -1) &&
    index(query_string, 'stok=') == -1) {
    is_login_page = true;
}

// ==========================================================
// ğŸ›¡ï¸ 2FA æ‹¦æˆªæ ¸å¿ƒé€»è¾‘ (ç»“æŸ)
// ==========================================================

// é€šç”¨ 2FA è¾“å…¥æ¡†æ³¨å…¥ JS (é€‚ç”¨äºæ‰€æœ‰ä¸»é¢˜)
const simple2fa_inject_js = `
<script>
(function() {
    // ç­‰å¾… DOM åŠ è½½å®Œæˆ
    function injectTokenField() {
        // æŸ¥æ‰¾å¯†ç è¾“å…¥æ¡†
        var passInput = document.querySelector('input[type="password"][name="luci_password"]');
        if (!passInput) {
            // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œç¨åé‡è¯•
            setTimeout(injectTokenField, 100);
            return;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ç»æ³¨å…¥è¿‡
        if (document.querySelector('input[name="token"]')) return;
        
        // åˆ›å»ºéªŒè¯ç è¾“å…¥æ¡†
        var tokenInput = document.createElement('input');
        tokenInput.type = 'text';
        tokenInput.name = 'token';
        tokenInput.placeholder = '${_("2FA Token (Leave empty if not enabled)")}';
        tokenInput.autocomplete = 'off';
        tokenInput.className = passInput.className;
        tokenInput.style.cssText = passInput.style.cssText;
        tokenInput.style.marginTop = '10px';
        
        // æ‰¾åˆ°å¯†ç æ¡†çš„çˆ¶å®¹å™¨å¹¶æ’å…¥
        var parent = passInput.parentElement;
        if (parent) {
            // å°è¯•æ‰¾åˆ°åŒ…å«å¯†ç æ¡†çš„ div å®¹å™¨
            var container = parent;
            while (container && container.tagName !== 'FORM' && !container.classList.contains('input-container') && !container.classList.contains('cbi-value')) {
                if (container.nextElementSibling) break;
                container = container.parentElement;
            }
            
            // åˆ›å»ºä¸€ä¸ªåŒ…è£… div
            var wrapper = document.createElement('div');
            wrapper.style.marginTop = '10px';
            wrapper.appendChild(tokenInput);
            
            // æ’å…¥åˆ°å¯†ç æ¡†å®¹å™¨åé¢
            if (parent.nextElementSibling) {
                parent.parentElement.insertBefore(wrapper, parent.nextElementSibling);
            } else {
                parent.parentElement.appendChild(wrapper);
            }
        }
        
        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯ (å¦‚æœæœ‰)
        if (window.location.search.indexOf('simple2fa_err=1') !== -1) {
            var errDiv = document.createElement('div');
            errDiv.style.cssText = 'color: #d9534f; background: #f2dede; border: 1px solid #ebccd1; padding: 10px; margin-bottom: 15px; border-radius: 4px;';
            errDiv.innerText = '${_("Invalid 2FA token, please try again")}';
            
            var form = document.querySelector('form');
            if (form) {
                form.insertBefore(errDiv, form.firstChild);
            }
            
            // æ¸…é™¤ URL å‚æ•°
            if (history.replaceState) {
                history.replaceState(null, '', window.location.pathname);
            }
        }
    }
    
    // é¡µé¢åŠ è½½åæ‰§è¡Œ
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', injectTokenField);
    } else {
        injectTokenField();
    }
})();
</script>
`;

// é‡å†™ read å‡½æ•°
function read(len) {
    if (buffer) {
        if (buffer_pos >= length(buffer)) return null;
        let chunk_len = min(length(buffer) - buffer_pos, len ?? input_bufsize);
        let chunk = substr(buffer, buffer_pos, chunk_len);
        buffer_pos += chunk_len;
        return chunk;
    } else {
        if (content_len <= 0) {
            stdin.close();
            return null;
        }
        let chunk = stdin.read(min(content_len, len ?? input_bufsize, input_bufsize));
        if (chunk == null) {
            content_len = 0;
            stdin.close();
        } else {
            content_len -= length(chunk);
        }
        return chunk;
    }
}

// é‡å†™ write å‡½æ•°ï¼šå¦‚æœæ˜¯ç™»å½•é¡µé¢ï¼Œç¼“å­˜å“åº”å¹¶æ³¨å…¥ JS
function write(data) {
    if (is_login_page) {
        response_buffer += data;
        return length(data);
    }
    return stdout.write(data);
}

// æ­£å¸¸åˆ†å‘è¯·æ±‚
let req = request(getenv(), read, write);
dispatch(req);
req.close();

// å¦‚æœæ˜¯ç™»å½•é¡µé¢ï¼Œåœ¨ </body> å‰æ³¨å…¥ JS
if (is_login_page && length(response_buffer) > 0) {
    // åœ¨ </body> æˆ– </html> å‰æ³¨å…¥
    let inject_pos = index(response_buffer, '</body>');
    if (inject_pos == -1) inject_pos = index(response_buffer, '</html>');
    
    if (inject_pos != -1) {
        let output = substr(response_buffer, 0, inject_pos) + simple2fa_inject_js + substr(response_buffer, inject_pos);
        stdout.write(output);
    } else {
        // æ²¡æ‰¾åˆ°åˆé€‚ä½ç½®ï¼Œç›´æ¥è¿½åŠ 
        stdout.write(response_buffer + simple2fa_inject_js);
    }
}