<% local uci=require "luci.model.uci" .cursor() local token=uci:get("vpnrss", "global" , "token" ) or "" %>

	<script type="text/javascript">
		function vpnrss_generate_uuid(id) {
			var u = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
				var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
				return v.toString(16);
			});
			var container = document.getElementById(id);
			if (container) {
				var input = container;
				if (container.tagName !== 'INPUT') {
					var inputs = container.getElementsByTagName('input');
					if (inputs.length > 0) {
						input = inputs[0];
					}
				}
				input.value = u;
			}
			return false;
		}
	</script>

	<fieldset class="cbi-section">
		<legend>
			<%:Subscription Links%>
		</legend>
		<div class="cbi-section-descr">
			<%:Use these links in your client. If no token is set, the links will be public, please share with caution!%>
		</div>

		<div class="cbi-section-node">
			<script type="text/javascript">
				function copyToClipboard(elementId) {
					var aux = document.createElement("input");
					aux.setAttribute("value", document.getElementById(elementId).innerText);
					document.body.appendChild(aux);
					aux.select();
					document.execCommand("copy");
					document.body.removeChild(aux);
					alert('<%:Copied!%>');
				}

				function getBaseUrl() {
					var protocol = window.location.protocol;
					var host = window.location.host;
					var token = "<%=token%>";
					var query = (token && token !== "") ? "?token=" + token : "";
					// If query already exists (no token but empty ?), handle it?
					// Actually cleaner to just append
					return protocol + "//" + host + "/cgi-bin/luci/vpnrss/subscribe" + query;
				}

				function renderLink(id, type) {
					var url = getBaseUrl();
					if (url.indexOf("?") === -1) {
						url += "?client=" + type;
					} else {
						url += "&client=" + type;
					}
					document.write('<div style="margin-bottom:10px;">');
					document.write('<strong>' + id + ': </strong>');
					document.write('<code id="link_' + id + '">' + url + '</code> ');
					document.write('<button class="cbi-button cbi-button-apply" onclick="copyToClipboard(\'link_' + id + '\')"><%:Copy%></button>');
					document.write('</div>');
				}
			</script>

			<h3>Clash / Clash Meta</h3>
			<script>renderLink('Clash', 'clash');</script>

			<h3>Sing-box</h3>
			<script>renderLink('Singbox', 'singbox');</script>

			<h3>Passwall / SSR+ / v2rayNG / 通用 (Base64)</h3>
			<script>renderLink('Generic', 'base64');</script>
		</div>
	</fieldset>